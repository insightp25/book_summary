# 섹션0. 오리엔테이션

# 내가 하는 TDD는 왜 실패하는가?

레거시 시스템 존재  
서비스 성장, 조직 차원에서 서비스 더 키우기로 결정, 인력 충원  
커뮤니케이션 비용 발생, 인력은 두 배가 됐지만 개발 속도는 두 배가 되지 못해
배포가 무섭다  
혹시라도 내가 개발하거나 수정한 코드가 이미 잘 동작하는 기능들에 영향을 줘서 서비스에 장애가 날까봐 겁난다는 얘기  
신입이 특히 이런 고민 많이 해  

문제는 회귀 버그 regression  
잘 동작하는 기능들이 이번 배포로 인해서 동작하지 않던 시절로 '회귀'  
(해외문서 이 용어 자주 등장)  
업무 대부분 시간을 인수 테스트에 너무 많이 소비  

회귀 버그에 아주 효과적이라는 '테스트 자동화' 검토

조직장 입장에선 윗선에 업무 성과 보고를 위해 가시적 성과 필요로 해

테스트를 추가하는 건 소프트웨어의 내적 품질을 올리는 일이지 실제로 사용자가 체감할 만한 외적 품질을 올리는 일은 아니다

성과 지표로 딱 삼기 좋은 '커버리지'

사업 계획으로 6개월 안에 커버리지 50% 달성, 소프트웨어의 내적 품질을 올리겠다고 보고
현재의 기능 개발 속도를 그대로 유지하면서

테스트 자동화  
간단한 것으로 테스트  
'이렇게 당연한 건데도 테스트가 필요하나?'  
일단 커버리지 충족

테스트하기 어려운 무언가 등장...  
외부 결제 시스템 연동을 어떻게 테스트?  
DB연동은 어떻게 테스트?

@Service 테스트를 짜는데, Service의 메서드는 정말 간단한 로직    
이걸 위한 준비 작업이 너무 많아

예를 들어 프로필 수정 로직이라 jpaRepository.save()만 호출하는 데에 온갖 삽질

h2 붙이고, 스프링 부트 띄우고, 의존성 추적해서 선언도 하고...  
예전 같으면 5분이면 개발할 내용이 30분이 걸린다


비결정적 테스트들  
어제 성공, 오늘 실패  
테스트 돌릴 때마다 테스트 결과 달라, 문제 없는 코드 디버깅에 시간 낭비  

너무 느리고, 비결정적이고, 뭘 하는 테스트인지 눈에 잘 안들어와  
'이럴 거면 테스트를 왜 만든 거지?'

대부분의 프로젝트가 이렇다 

1. 레거시 코드에 테스트를 넣는게, TDD가 아니다
  - TDD는 내용 자체는 별거 아니지만 생각한 것보다 많이 어렵다
  - 애초에 TDD 얘기 전에 본인의 코드에 테스트를 넣는 방법을 먼저 알아야 한다
    - TDD랑 테스트랑 개념을 섞어 썼다가 이도 저도 아니게 된 결과를 얻게 된다 -> 테스트를 '자연스럽게' 넣는 법을 알아야 한다
2. 레거시에 테스트를 넣으려면 코드 개선이 필요하다
  - 테스트의 목적
    1. 회귀 버그 방지
    2. 유연한 설계로 개선
      1. 테스트를 쉽게 만들어줌
      2. 테스트를 결정적이게 만들어줌
  - 테스트가 어려웠던 이유: '프로젝트가 뻣뻣한 설계를 갖고 있었기 때문'
    - 프로젝트가 스프링이나 JPA에 의존적인 상태일 확률이 높아
      - 테스트를 짜다 보면, 테스트가 '외부 시스템에 의존하는 상황을 피하라고' 계속해서 신호를 보내 -> 개발자는 캐치해서 설계를 진화시켜야 하는데, 그냥 mockito 프레임워크 등을 써서 해결
    - 테스트와 설계는 긴밀한 상호 관계 가져 -> 그래서 레거시에 테스트를 넣는 과정은 필히 코드 개선을 하면서 진행됐어야
      - 테스트를 고민하면 설계가 개선되고, 설계를 고민하면 테스트가 쉬워져
      - 테스트가 보내는 신호를 놓치면 테스트와 설계 둘 다 놓쳐
  - 동시에 매우 도전적인 일
    - 우리 시스템이 회귀 테스트가 없을시 설계 건드렸다가 장애나면 난리...
    - 테스트 자동화는 IT 회사에 도입된 지 생각보다 얼마 안 된 개념(구글 2005년 도입) -> 대부분의 프로젝트들이 테스트 고려하지 않았을 확률 높아.
3. 커버리지에 집착하면 안된다
  - 생각보다 테스트 불필요 부분 있어
  - 테스트 추가시엔 얻을 수 있는 효용성을 생각해봐야지 커버리지 자체가 목적이 되면 테스트 장점 놓치게 돼

### 결과

왜 테스트를 해야하고, 테스트로 얻을 수 있는 핵심 가치가 무엇이고, 어떻게 테스트 해야하는지 고민하지 않아

<br><br><br>

### 해설

- 서비스가 성장함에 따라 시스템 규모가 계속해 커지는데, '회귀 버그'만을 신경쓰는 테스트코드는 자동차로 치면 모든 부품들 동작여부를 체크하는 것과 같아.
  - 물론 분명 가치가 있지만 테스트가 주는 가치를 모두 사용하진 못해
  - 신규 개발이 되면 여기에 대응하는 테스트 코드를 또 만들어야
- 반대로 테스트와 확장성을 동시에 지니는 서비스
  - 사용자가 몰리면 그냥 후미에 호차 하나만 더 추가
  - 후미의 호차는 테스트로 이미 안전성 검증된 객실


### 해결책

> TDD를 논하기 전에 테스트가 가능한 구조로 변경 되어야 한다



